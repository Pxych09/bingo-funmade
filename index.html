<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Bingo: Funmade 2026</title>

  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/6329/6329747.png" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  >

  <style>
    body { padding: 24px; }

    #mainBoard {
      padding: 8px;
      width: min(700px, 100%);
    }

    .card {
      padding: 4px;
      border: 1px solid blue;
      width: 300px;
      margin: .5rem auto;
    }

    .card > div:first-of-type {
      font-size: .65em;
    }

    .card span {
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
    }

    /* Marked numbers */
    .marked {
      background: #198754 !important;
      color: #fff !important;
    }

    /* FREE space */
    .free-space {
      background: #ffc107 !important;
      font-weight: 700;
      color: #111 !important;
    }

    /* Winner card highlight */
    .winner {
      border: 2px solid #198754 !important;
      box-shadow: 0 0 0 4px rgba(25, 135, 84, 0.25);
    }

    /* Winning line cell highlight */
    .win-line {
      outline: 3px solid rgba(255, 193, 7, 0.9);
      outline-offset: -2px;
    }

    /* Rolled number animation */
    #rolledNumber.roll-animate {
      display: inline-block;
      animation: pop 250ms ease-out;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      55% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }

    .toast { min-width: 260px; }

    /* Cards header (B I N G O) styling */
    .bingo-letter{
      background: linear-gradient(135deg,#0d6efd,#6610f2);
      color:white;
      padding:6px 0;
      border-radius:6px;
      letter-spacing:2px;
      font-size:1rem;
      font-weight: 800;
    }

    /* Called Balls Grid */
    .called-grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:6px;
      padding:12px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fafafa;
    }
    .grid-header{
      font-weight:800;
      text-align:center;
      padding:6px;
      border-radius:6px;
      background:#0d6efd;
      color:white;
    }
    .grid-ball{
      height:32px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.75rem;
      font-weight:700;
      background:#e9ecef;
      transition:.2s;
      user-select:none;
    }
    .grid-ball.called{
      background:#198754;
      color:white;
      transform:scale(1.06);
    }
  </style>
</head>

<body>
  <div class="container border border-1 shadow-lg mx-auto" id="mainBoard">

    <nav class="border border-1 border-danger p-2 rounded-3">
      <div class="container mb-2">
        <span class="fw-semibold">Number of cards: </span>
        <input type="number" id="numberOfCards" placeholder="input number of cards...." class="form-control form-control-sm d-inline-block" style="width: 220px;">
      </div>

      <div class="container d-flex flex-wrap align-items-center gap-2">
        <span class="fw-semibold">Roll a ball:</span>
        <button id="rollBtn" class="btn btn-primary btn-sm">Roll</button>
        <button id="resetBtn" class="btn btn-outline-danger btn-sm">Reset</button>

        <span class="ms-2 fw-semibold">Result:</span>
        <span id="rolledNumber" class="fw-bold fs-5">0</span>
      </div>
    </nav>

    <!-- Winners / Status -->
    <div class="container my-2 d-flex flex-wrap gap-2 align-items-center">
      <div class="badge text-bg-secondary" id="calledCount">Called: 0</div>
      <div class="badge text-bg-success d-none" id="winnerCount">Winners: 0</div>
    </div>


    <!-- Bootstrap Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
      <div id="winToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="winToastBody">BINGO!</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>

      <div id="infoToast" class="toast align-items-center text-bg-primary border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="infoToastBody">Ready.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- Cards -->
    <section id="cardsContainer"></section>

        
    <hr>
    <!-- Called Balls Grid -->
    <div class="container my-3">
      <div class="fw-semibold mb-2">Dashboard: Called Balls</div>

      <div id="calledBallsGrid" class="called-grid">
        <div class="grid-header">B</div>
        <div class="grid-header">I</div>
        <div class="grid-header">N</div>
        <div class="grid-header">G</div>
        <div class="grid-header">O</div>
      </div>
    </div>


  </div>

  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    const el_numberOfCards = document.querySelector("#numberOfCards");
    const cardsContainer = document.querySelector("#cardsContainer");
    const rollBtn = document.querySelector("#rollBtn");
    const resetBtn = document.querySelector("#resetBtn");
    const rolledNumberDisplay = document.querySelector("#rolledNumber");

    const calledCountEl = document.querySelector("#calledCount");
    const winnerCountEl = document.querySelector("#winnerCount");

    const calledBallsGrid = document.querySelector("#calledBallsGrid");

    const winToastEl = document.querySelector("#winToast");
    const winToastBody = document.querySelector("#winToastBody");
    const infoToastEl = document.querySelector("#infoToast");
    const infoToastBody = document.querySelector("#infoToastBody");

    const winToast = new bootstrap.Toast(winToastEl, { delay: 3500 });
    const infoToast = new bootstrap.Toast(infoToastEl, { delay: 2200 });

    function showWinToast(message) {
      winToastBody.textContent = message;
      winToast.show();
    }

    function showInfoToast(message) {
      infoToastBody.textContent = message;
      infoToast.show();
    }

    // === APPS SCRIPT API (JSONP) ===
const API_URL = "https://script.google.com/macros/s/AKfycbyS_FsFLMBpQduyoBHK65MY7XdfwFrtEl2NTXLKrZOGMWqUGnkOSeqOrSP3lfLKhCtdqw/exec"; // e.g. https://script.google.com/macros/s/XXXXX/exec

async function makeAPICall(payload) {
  // JSONP first (works around CORS)
  try {
    return await jsonpRequest(payload);
  } catch (e) {
    console.warn("JSONP failed:", e);
  }

  // Optional POST fallback (usually blocked by CORS unless same-origin / proper headers)
  try {
    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
    });
    if (response.ok) return await response.json();
  } catch (e) {}

  return { success: false, message: "Request failed (CORS or network)." };
}

function jsonpRequest(payload) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const params = new URLSearchParams();

    Object.entries(payload).forEach(([k, v]) => {
      params.append(k, typeof v === "object" ? JSON.stringify(v) : v);
    });

    params.append("callback", cb);

    const script = document.createElement("script");
    script.src = `${API_URL}?${params.toString()}`;

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP script load error"));
    };

    function cleanup() {
      delete window[cb];
      script.remove();
    }

    document.body.appendChild(script);
  });
}

async function loadBingoDataFromSheet() {
  const res = await makeAPICall({ action: "getBingoData" });
  if (!res || !res.success) {
    throw new Error(res?.message || "Failed to load bingo data.");
  }
  return res.bingo_data; // {b:[], i:[], n:[], g:[], o:[]}
}


    const totalBox = 5;

    let bingo_data = null; // will be loaded from Google Sheet API

    let calledNumbers = [];
    let winners = new Set();

    function updateBadges() {
      calledCountEl.textContent = `Called: ${calledNumbers.length}`;
      const w = winners.size;
      if (w > 0) {
        winnerCountEl.classList.remove("d-none");
        winnerCountEl.textContent = `Winners: ${w}`;
      } else {
        winnerCountEl.classList.add("d-none");
      }
    }

    function sampleUnique(arr, count) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, count);
    }

    function getLetterForNumber(n) {
      if (n >= 1 && n <= 15) return "B";
      if (n >= 16 && n <= 30) return "I";
      if (n >= 31 && n <= 45) return "N";
      if (n >= 46 && n <= 60) return "G";
      return "O";
    }

    function playRollSound() {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 740;
        g.gain.value = 0.05;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, 120);
      } catch (_) {}
    }

    function animateRolledNumber() {
      rolledNumberDisplay.classList.remove("roll-animate");
      void rolledNumberDisplay.offsetWidth;
      rolledNumberDisplay.classList.add("roll-animate");
    }

    /* Called Balls Grid (BINGO layout 5 cols x 15 rows) */
    function buildCalledGrid() {
      calledBallsGrid.querySelectorAll(".grid-ball").forEach(el => el.remove());

      const ranges = [
        [1, 15],   // B
        [16, 30],  // I
        [31, 45],  // N
        [46, 60],  // G
        [61, 75],  // O
      ];

      for (let row = 0; row < 15; row++) {
        for (let col = 0; col < 5; col++) {
          const number = ranges[col][0] + row;

          const cell = document.createElement("div");
          cell.className = "grid-ball";
          cell.dataset.number = String(number);
          cell.textContent = number; // JUST THE NUMBER âœ…

          calledBallsGrid.appendChild(cell);
        }
      }
    }

    function renderCalledBalls() {
      document.querySelectorAll(".grid-ball").forEach(ball => {
        const num = parseInt(ball.dataset.number, 10);
        if (calledNumbers.includes(num)) ball.classList.add("called");
        else ball.classList.remove("called");
      });
    }

    function createCell(text, cardIndex, row, col, isFree = false) {
      const span = document.createElement("span");
      span.classList.add("text-center", "bg-light");

      span.dataset.card = String(cardIndex);
      span.dataset.row = String(row);
      span.dataset.col = String(col);

      if (isFree) {
        span.textContent = "FREE";
        span.classList.remove("bg-light");
        span.classList.add("free-space", "marked");
        span.dataset.number = "FREE";
      } else {
        span.textContent = text;
        span.dataset.number = String(text);
      }

      // click-to-mark (optional)
      span.addEventListener("click", () => {
        if (span.textContent === "FREE") return;
        span.classList.toggle("marked");
        checkAllWinners();
      });

      return span;
    }

    function createColumn(letterKey, cardIndex, colIndex) {
      const column = document.createElement("div");
      column.classList.add("d-flex", "flex-column", "gap-1", "w-100");

    const source = (bingo_data && bingo_data[letterKey]) ? bingo_data[letterKey] : [];
    const nums = sampleUnique(source, totalBox);


      nums.forEach((num, rowIndex) => {
        const isFree = (letterKey === "n" && rowIndex === 2);
        column.appendChild(createCell(num, cardIndex, rowIndex, colIndex, isFree));
      });

      return column;
    }

    function createCard(cardNumber) {
      const cardIndex = cardNumber - 1;

      const card = document.createElement("div");
      card.classList.add("card", "p-2", "border-primary", "shadow-sm");
      card.dataset.card = String(cardIndex);

      const headerTop = document.createElement("div");
      headerTop.classList.add("bg-info", "text-dark", "small", "px-2", "rounded-2", "d-flex", "gap-2");
      headerTop.innerHTML = `<span>Card No.:</span> <span>${String(cardNumber).padStart(2, "0")}</span>`;

      const headerLetters = document.createElement("div");
      headerLetters.classList.add("d-flex", "justify-content-evenly", "fw-bold", "py-2", "gap-1");
      headerLetters.innerHTML = `
        <div class="w-100 text-center bingo-letter">B</div>
        <div class="w-100 text-center bingo-letter">I</div>
        <div class="w-100 text-center bingo-letter">N</div>
        <div class="w-100 text-center bingo-letter">G</div>
        <div class="w-100 text-center bingo-letter">O</div>
      `;

      const body = document.createElement("div");
      body.classList.add("d-flex", "gap-1");
      ["b","i","n","g","o"].forEach((letter, colIndex) => {
        body.appendChild(createColumn(letter, cardIndex, colIndex));
      });

      card.appendChild(headerTop);
      card.appendChild(headerLetters);
      card.appendChild(body);

      return card;
    }

    function generateCards() {
      const count = Math.max(0, parseInt(el_numberOfCards.value) || 0);
      cardsContainer.replaceChildren();
      winners.clear();

      for (let i = 1; i <= count; i++) {
        cardsContainer.appendChild(createCard(i));
      }

      calledNumbers = [];
      rolledNumberDisplay.textContent = "0";
      updateBadges();
      renderCalledBalls();
      showInfoToast("Cards generated.");
    }

    function highlightNumber(number) {
      document
        .querySelectorAll(`span[data-number="${number}"]`)
        .forEach(cell => cell.classList.add("marked"));
    }

    function rollBall() {
      const cardCount = parseInt(el_numberOfCards.value) || 0;
      if (cardCount <= 0) return;

      if (calledNumbers.length >= 75) {
        showInfoToast("All numbers have been called!");
        return;
      }

      let number;
      do {
        number = Math.floor(Math.random() * 75) + 1;
      } while (calledNumbers.includes(number));

      calledNumbers.push(number);

      const letter = getLetterForNumber(number);
      rolledNumberDisplay.textContent = `${letter}-${number}`;

      animateRolledNumber();
      playRollSound();

      renderCalledBalls();
      highlightNumber(number);
      checkAllWinners();

      updateBadges();
      showInfoToast(`Rolled ${letter}-${number}`);
    }

    /* Winner detection with pattern info + win-line highlighting */
    function checkWinnerForCard(cardIndex) {
      const size = 5;

      const getCell = (r, c) =>
        document.querySelector(`.card[data-card="${cardIndex}"] span[data-row="${r}"][data-col="${c}"]`);

      const marked = Array.from({ length: size }, () => Array(size).fill(false));
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          const cell = getCell(r, c);
          marked[r][c] = !!cell && cell.classList.contains("marked");
        }
      }

      // rows
      for (let r = 0; r < size; r++) {
        if (marked[r].every(Boolean)) {
          const cells = Array.from({ length: size }, (_, c) => getCell(r, c)).filter(Boolean);
          return { won: true, label: `Row ${r + 1}`, cells };
        }
      }

      // cols
      const colNames = ["B", "I", "N", "G", "O"];
      for (let c = 0; c < size; c++) {
        let ok = true;
        for (let r = 0; r < size; r++) {
          if (!marked[r][c]) { ok = false; break; }
        }
        if (ok) {
          const cells = Array.from({ length: size }, (_, r) => getCell(r, c)).filter(Boolean);
          return { won: true, label: `Column ${colNames[c]}`, cells };
        }
      }

      // diagonals
      let d1 = true;
      for (let i = 0; i < size; i++) if (!marked[i][i]) d1 = false;
      if (d1) {
        const cells = Array.from({ length: size }, (_, i) => getCell(i, i)).filter(Boolean);
        return { won: true, label: `Diagonal (â†˜ï¸Ž)`, cells };
      }

      let d2 = true;
      for (let i = 0; i < size; i++) if (!marked[i][size - 1 - i]) d2 = false;
      if (d2) {
        const cells = Array.from({ length: size }, (_, i) => getCell(i, size - 1 - i)).filter(Boolean);
        return { won: true, label: `Diagonal (â†™ï¸Ž)`, cells };
      }

      return { won: false, label: "", cells: [] };
    }

    function checkAllWinners() {
      const count = parseInt(el_numberOfCards.value) || 0;

      for (let cardIndex = 0; cardIndex < count; cardIndex++) {
        if (winners.has(cardIndex)) continue;

        const result = checkWinnerForCard(cardIndex);

        if (result.won) {
          winners.add(cardIndex);

          const cardEl = document.querySelector(`.card[data-card="${cardIndex}"]`);
          if (cardEl) cardEl.classList.add("winner");

          // highlight winning line cells
          result.cells.forEach(cell => cell.classList.add("win-line"));

          showWinToast(
            `ðŸŽ‰ BINGO! Card No. ${String(cardIndex + 1).padStart(2, "0")} â€” ${result.label}`
          );

          updateBadges();
        }
      }
    }

    function resetGame() {
      calledNumbers = [];
      winners.clear();
      rolledNumberDisplay.textContent = "0";

      document.querySelectorAll(".card").forEach(card => card.classList.remove("winner"));
      document.querySelectorAll(".card span").forEach(span => {
        span.classList.remove("win-line");
        if (span.textContent === "FREE") span.classList.add("marked");
        else span.classList.remove("marked");
      });

      updateBadges();
      renderCalledBalls();
      showInfoToast("Game reset.");
    }

    el_numberOfCards.addEventListener("input", generateCards);
    rollBtn.addEventListener("click", rollBall);
    resetBtn.addEventListener("click", resetGame);

    // Init
(async function init() {
  el_numberOfCards.value = 3;
  buildCalledGrid();

  try {
    showInfoToast("Loading bingo data from Google Sheet...");
    bingo_data = await loadBingoDataFromSheet();
    showInfoToast("Bingo data loaded âœ…");
  } catch (err) {
    console.error(err);
    showInfoToast("Failed to load sheet data. Using fallback.");
    // Fallback if API fails (keeps app working)
    bingo_data = {
      b: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
      i: [16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],
      n: [31,32,33,34,35,36,37,38,39,40,41,42,43,44,45],
      g: [46,47,48,49,50,51,52,53,54,55,56,57,58,59,60],
      o: [61,62,63,64,65,66,67,68,69,70,71,72,73,74,75],
    };
  }

  generateCards();
  renderCalledBalls();
})();

  </script>
</body>
</html>
